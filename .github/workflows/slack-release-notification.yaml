name: Slack Release Notification

on:
  push:
    branches:
      - main

jobs:
  checkType:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: Find last merge
      run: |
        echo "current_commit=$(git log --pretty='%H' -1)" >> $GITHUB_ENV
        echo "last_merge=$(git log --pretty='%H' --merges -1)" >> $GITHUB_ENV
    outputs:
      last_merge: ${{ env.last_merge }}
      current_commit: ${{ env.current_commit }}
  directCommit:
    runs-on: ubuntu-latest
    needs: checkType
    if: ${{ needs.checkType.outputs.last_merge }} != ${{ needs.checkType.outputs.current_commit }}
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: get commit message
      run: echo "commit_message=$(git log --pretty='%s' -1)" >> $GITHUB_ENV
    - name: debug
      run: |
        echo ${{ env.commit_message }}
    # the following action is based on a workflow created by Andreas Haller, contact for permissions, the workflow file to import can be found under tools/slack
    # - name: Notify Slack
    #   uses: slackapi/slack-github-action@v1.23.0
    #   env:
    #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_NOTIFICATION_WEBHOOK }}
    #   with:
    #     payload: |
    #       {
    #         "text": "Direct commit to main: ${{ env.commit_message }}"
    #       }
  mergeCommit:
    runs-on: ubuntu-latest
    needs: checkType
    if: ${{ needs.checkType.outputs.last_merge }} == ${{ needs.checkType.outputs.current_commit }}
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: debug
      run: |
        echo ${{ needs.checkType.outputs.last_merge }}
        echo ${{ needs.checkType.outputs.current_commit }}
    # the following action is based on a workflow created by Andreas Haller, contact for permissions, the workflow file to import can be found under tools/slack
    # - name: Notify Slack
    #   uses: slackapi/slack-github-action@v1.23.0
    #   env:
    #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_NOTIFICATION_WEBHOOK }}
    #   with:
    #     payload: |
    #       {
    #         "text": "New code version released."
    #       }
